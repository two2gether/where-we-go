name: AWS Deployment Pipeline

on:
  push:
    branches: [ dev, main, feat/place-system ]
  pull_request:
    branches: [ dev, main, feat/place-system ]

env:
  JAVA_VERSION: '17'
  AWS_REGION: 'ap-northeast-2'  # ì„œìš¸ ë¦¬ì „

jobs:
  # ===============================
  # í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œ ì‘ì—…
  # ===============================
  test-and-build:
    name: ğŸ§ª Test & Build JAR
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: â˜• Java 17 ì„¤ì •
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'corretto'  # AWS Corretto ì‚¬ìš©

    - name: ğŸ˜ Gradle ìºì‹œ ì„¤ì •
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: ğŸ”‘ Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      run: chmod +x ./gradlew

    - name: ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      env:
        # í…ŒìŠ¤íŠ¸ìš© í™˜ê²½ë³€ìˆ˜
        SPRING_PROFILES_ACTIVE: test
        JWT_SECRET: test-jwt-secret-key
      run: ./gradlew test --info

    - name: ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          build/reports/tests/test/
          build/test-results/test/

    - name: ğŸ—ï¸ JAR íŒŒì¼ ë¹Œë“œ
      env:
        SPRING_PROFILES_ACTIVE: aws
      run: ./gradlew bootJar -x test

    - name: ğŸ“¦ JAR íŒŒì¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: application-jar
        path: build/libs/*.jar

  # ===============================
  # AWS Elastic Beanstalk ë°°í¬
  # ===============================
  deploy-to-aws:
    name: ğŸš€ Deploy to AWS
    runs-on: ubuntu-latest
    needs: test-and-build
    if: github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/main'
    
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}
    
    steps:
    - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ğŸ“¦ JAR íŒŒì¼ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v4
      with:
        name: application-jar
        path: ./

    - name: ğŸ·ï¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ë²„ì „ ìƒì„±
      id: version
      run: |
        VERSION="v$(date +%Y%m%d-%H%M%S)-$(echo ${{ github.sha }} | cut -c1-7)"
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Generated version: ${VERSION}"

    - name: ğŸ“ ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„±
      run: |
        # ë°°í¬ì— í•„ìš”í•œ íŒŒì¼ë“¤ì„ í•˜ë‚˜ì˜ ë””ë ‰í„°ë¦¬ì— ëª¨ìŒ
        mkdir -p deploy-package
        
        # JAR íŒŒì¼ ë³µì‚¬ (ì´ë¦„ í‘œì¤€í™”)
        cp *.jar deploy-package/application.jar
        
        # Elastic Beanstalk ì„¤ì • íŒŒì¼ë“¤ ë³µì‚¬
        cp -r .ebextensions deploy-package/
        
        # ì¶”ê°€ ì„¤ì • íŒŒì¼ë“¤ (í•„ìš”ì‹œ)
        cp -r src/main/resources/application-aws.properties deploy-package/ || true
        
        # ë°°í¬ íŒ¨í‚¤ì§€ ì••ì¶•
        cd deploy-package
        zip -r ../deploy-package.zip .
        cd ..
        
        echo "Deploy package contents:"
        unzip -l deploy-package.zip

    - name: â˜ï¸ AWS ìê²© ì¦ëª… ì„¤ì •
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: ğŸ“¤ S3ì— ë°°í¬ íŒ¨í‚¤ì§€ ì—…ë¡œë“œ
      run: |
        # S3 ë²„í‚·ì— ë°°í¬ íŒ¨í‚¤ì§€ ì—…ë¡œë“œ
        aws s3 cp deploy-package.zip s3://${{ vars.AWS_S3_BUCKET }}/wherewego/${{ steps.version.outputs.version }}/deploy-package.zip
        echo "Uploaded to: s3://${{ vars.AWS_S3_BUCKET }}/wherewego/${{ steps.version.outputs.version }}/deploy-package.zip"

    - name: ğŸ­ Elastic Beanstalk ì• í”Œë¦¬ì¼€ì´ì…˜ ë²„ì „ ìƒì„±
      run: |
        # ì• í”Œë¦¬ì¼€ì´ì…˜ ë²„ì „ ìƒì„±
        aws elasticbeanstalk create-application-version \
          --application-name ${{ vars.EB_APPLICATION_NAME }} \
          --version-label ${{ steps.version.outputs.version }} \
          --source-bundle S3Bucket=${{ vars.AWS_S3_BUCKET }},S3Key=wherewego/${{ steps.version.outputs.version }}/deploy-package.zip \
          --description "Deployed via GitHub Actions - ${{ github.sha }}"

    - name: ğŸš€ Elastic Beanstalk í™˜ê²½ ë°°í¬
      run: |
        # í™˜ê²½ë³„ ë°°í¬
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          ENVIRONMENT_NAME="${{ vars.EB_ENVIRONMENT_NAME_PROD }}"
        else
          ENVIRONMENT_NAME="${{ vars.EB_ENVIRONMENT_NAME_DEV }}"
        fi
        
        echo "Deploying to environment: ${ENVIRONMENT_NAME}"
        
        # í™˜ê²½ ì—…ë°ì´íŠ¸
        aws elasticbeanstalk update-environment \
          --application-name ${{ vars.EB_APPLICATION_NAME }} \
          --environment-name ${ENVIRONMENT_NAME} \
          --version-label ${{ steps.version.outputs.version }}

    - name: â³ ë°°í¬ ì™„ë£Œ ëŒ€ê¸°
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          ENVIRONMENT_NAME="${{ vars.EB_ENVIRONMENT_NAME_PROD }}"
        else
          ENVIRONMENT_NAME="${{ vars.EB_ENVIRONMENT_NAME_DEV }}"
        fi
        
        echo "Waiting for deployment to complete..."
        
        # ìµœëŒ€ 10ë¶„ ëŒ€ê¸°
        aws elasticbeanstalk wait environment-updated \
          --application-name ${{ vars.EB_APPLICATION_NAME }} \
          --environment-names ${ENVIRONMENT_NAME} \
          --max-attempts 20 \
          --delay 30

  # ===============================
  # ë°°í¬ í›„ ê²€ì¦
  # ===============================
  post-deploy-verification:
    name: âœ… Post-Deploy Health Check
    runs-on: ubuntu-latest
    needs: deploy-to-aws
    if: always() && needs.deploy-to-aws.result == 'success'

    steps:
    - name: ğŸ¥ í—¬ìŠ¤ ì²´í¬
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          HEALTH_URL="${{ vars.PROD_HEALTH_CHECK_URL }}"
        else
          HEALTH_URL="${{ vars.DEV_HEALTH_CHECK_URL }}"
        fi
        
        echo "Health check URL: ${HEALTH_URL}"
        
        # í—¬ìŠ¤ ì²´í¬ (ìµœëŒ€ 5ë¶„ ì¬ì‹œë„)
        for i in {1..10}; do
          echo "Health check attempt ${i}/10..."
          
          if curl -f "${HEALTH_URL}/actuator/health" -o /dev/null -s; then
            echo "âœ… Health check passed!"
            exit 0
          fi
          
          echo "Health check failed, waiting 30 seconds..."
          sleep 30
        done
        
        echo "âŒ Health check failed after 10 attempts"
        exit 1

    - name: ğŸ§ª ê¸°ë³¸ API í…ŒìŠ¤íŠ¸
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          API_URL="${{ vars.PROD_API_URL }}"
        else
          API_URL="${{ vars.DEV_API_URL }}"
        fi
        
        echo "Testing API endpoints..."
        
        # ê¸°ë³¸ API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
        curl -f "${API_URL}/api/courses" -H "Accept: application/json" || echo "API test failed"

  # ===============================
  # ì•Œë¦¼
  # ===============================
  notify:
    name: ğŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs: [test-and-build, deploy-to-aws, post-deploy-verification]
    if: always()

    steps:
    - name: ğŸ“± ì„±ê³µ ì•Œë¦¼
      if: needs.deploy-to-aws.result == 'success' && needs.post-deploy-verification.result == 'success'
      run: |
        echo "ğŸ‰ AWS ë°°í¬ ì„±ê³µ!"
        echo "ë¸Œëœì¹˜: ${{ github.ref_name }}"
        echo "ì»¤ë°‹: ${{ github.sha }}"
        echo "ë°°í¬ í™˜ê²½: ${{ github.ref == 'refs/heads/main' && 'Production' || 'Development' }}"

    - name: ğŸš¨ ì‹¤íŒ¨ ì•Œë¦¼
      if: needs.test-and-build.result == 'failure' || needs.deploy-to-aws.result == 'failure'
      run: |
        echo "âŒ AWS ë°°í¬ ì‹¤íŒ¨!"
        echo "ë¸Œëœì¹˜: ${{ github.ref_name }}"
        echo "ì»¤ë°‹: ${{ github.sha }}"
        echo "ì‹¤íŒ¨ ë‹¨ê³„: ë¹Œë“œ/ë°°í¬"