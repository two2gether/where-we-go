name: EC2 Direct Deploy (feat/place-system)

on:
  push:
    branches: [ feat/place-system ]
  pull_request:
    branches: [ feat/place-system ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout source code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Grant permission to gradlew
      run: chmod +x ./gradlew
      
    - name: Build Spring Boot App
      run: ./gradlew clean build -x test
      
    - name: Upload JAR Artifact
      uses: actions/upload-artifact@v4
      with:
        name: wherewego-app
        path: build/libs/*.jar

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/feat/place-system'
    
    env:
      DB_HOST: ${{ secrets.DB_HOST2 }}
      DB_PORT: ${{ secrets.DB_PORT || '3306' }}
      DB_NAME: ${{ secrets.DB_NAME2 }}
      DB_USERNAME: ${{ secrets.DB_USERNAME2 }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD2 }}
      JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
      GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
    
    steps:
    - name: Download JAR Artifact
      uses: actions/download-artifact@v4
      with:
        name: wherewego-app
        
    - name: Create app directory on EC2
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_HOST2 }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY2 }}
        script: |
          mkdir -p /home/ubuntu/app
          
    - name: Copy JAR to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST2 }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY2 }}
        source: "*.jar"
        target: "/home/ubuntu/app/"
        overwrite: true
        
    - name: Stop existing application
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_HOST2 }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY2 }}
        script: |
          pkill -f 'java.*where-we-go' || true
          sleep 5
          
    - name: Start Spring Boot Application
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_HOST2 }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY2 }}
        envs: DB_HOST,DB_PORT,DB_NAME,DB_USERNAME,DB_PASSWORD,JWT_SECRET_KEY,GOOGLE_MAPS_API_KEY
        script: |
          cd /home/ubuntu/app
          
          # 환경변수 파일 생성
          cat > .env << EOF
          DB_HOST=$DB_HOST
          DB_PORT=$DB_PORT
          DB_NAME=$DB_NAME
          DB_USERNAME=$DB_USERNAME
          DB_PASSWORD=$DB_PASSWORD
          JWT_SECRET_KEY=$JWT_SECRET_KEY
          GOOGLE_MAPS_API_KEY=$GOOGLE_MAPS_API_KEY
          EOF
          
          # 환경변수 로드
          export $(cat .env | xargs)
          
          # Spring Boot 애플리케이션 시작
          nohup java -jar where-we-go-0.0.1-SNAPSHOT.jar \
            --spring.profiles.active=aws \
            --spring.datasource.url=jdbc:mysql://$DB_HOST:$DB_PORT/$DB_NAME?useSSL=false&serverTimezone=Asia/Seoul&allowPublicKeyRetrieval=true \
            --spring.datasource.username=$DB_USERNAME \
            --spring.datasource.password=$DB_PASSWORD \
            --jwt.secret.key=$JWT_SECRET_KEY \
            --google.api.key=$GOOGLE_MAPS_API_KEY \
            > app.log 2>&1 &
            
          # 애플리케이션 시작 확인
          sleep 15
          if pgrep -f 'java.*where-we-go' > /dev/null; then
            echo "✅ Application started successfully"
            echo "📋 Application log:"
            tail -20 app.log
          else
            echo "❌ Application failed to start"
            echo "📋 Error log:"
            cat app.log
            exit 1
          fi
          
    - name: Health Check
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_HOST2 }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY2 }}
        script: |
          # 헬스 체크 (최대 2분 재시도)
          for i in {1..4}; do
            echo "Health check attempt ${i}/4..."
            
            if curl -f "http://localhost:8080/actuator/health" -o /dev/null -s; then
              echo "✅ Health check passed!"
              curl -s "http://localhost:8080/actuator/health" | jq '.' || echo "Health endpoint responded"
              exit 0
            fi
            
            echo "Health check failed, waiting 30 seconds..."
            sleep 30
          done
          
          echo "❌ Health check failed after 4 attempts"
          echo "📋 Application log:"
          tail -50 /home/ubuntu/app/app.log
          exit 1