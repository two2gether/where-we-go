name: Deploy to AWS ECS

on:
  push:
    branches: [ main, dev, feature/docker-deployment ]

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: wherewego-app
  CONTAINER_NAME: wherewego-app

permissions:
  id-token: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/feature/docker-deployment'
    outputs:
      image-uri: ${{ steps.build-image.outputs.image }}
      environment: ${{ steps.set-env.outputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Notify build start
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENV_ICON="ğŸš€"
            ENV_NAME="Production"
          else
            ENV_ICON="ğŸ§ª"
            ENV_NAME="Development"
          fi
          
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"attachments\": [{
              \"color\": \"#36a64f\",
              \"blocks\": [{
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"$ENV_ICON *WhereWeGo Build Started* ğŸ”¨\\në¹Œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...\"
                }
              }, {
                \"type\": \"section\",
                \"fields\": [{
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Environment:*\\n$ENV_NAME\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Branch:*\\n\`${{ github.ref_name }}\`\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Commit:*\\n<https://github.com/${{ github.repository }}/commit/${{ github.sha }}|\`$(echo ${{ github.sha }} | cut -c1-8)\`>\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Author:*\\n${{ github.actor }}\"
                }]
              }]
            }]
          }" ${{ secrets.SLACK_WEBHOOK }}

      - name: Set environment variables
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          else
            echo "environment=prod" >> $GITHUB_OUTPUT
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\": \"âš™ï¸ Gradle ë¹Œë“œ ì¤‘... (ì•½ 1-2ë¶„ ì†Œìš”)\"}" ${{ secrets.SLACK_WEBHOOK }}
          
          ./gradlew clean build -x test

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-Build
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          BUILD_START=$(date +%s)
          
          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\": \"ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘... (ì•½ 2-3ë¶„ ì†Œìš”)\"}" ${{ secrets.SLACK_WEBHOOK }}
          
          # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          
          # latest íƒœê·¸ë„ í‘¸ì‹œ
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT
          
          BUILD_END=$(date +%s)
          BUILD_DURATION=$((BUILD_END - BUILD_START))
          
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"attachments\": [{
              \"color\": \"good\",
              \"blocks\": [{
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"ğŸ‰ *ë¹Œë“œ ì™„ë£Œ!* âœ…\\në°°í¬ ì¤€ë¹„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\"
                }
              }, {
                \"type\": \"section\",
                \"fields\": [{
                  \"type\": \"mrkdwn\",
                  \"text\": \"*ë¹Œë“œ ì‹œê°„:*\\nâ±ï¸ ${BUILD_DURATION}ì´ˆ\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*ë‹¤ìŒ ë‹¨ê³„:*\\nğŸš€ ë°°í¬ ì‹œì‘ ì˜ˆì •\"
                }]
              }]
            }]
          }" ${{ secrets.SLACK_WEBHOOK }}

  deploy:
    runs-on: ubuntu-latest
    needs: build
    outputs:
      cluster: ${{ steps.set-deploy-vars.outputs.cluster }}
      service: ${{ steps.set-deploy-vars.outputs.service }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set deployment variables
        id: set-deploy-vars
        run: |
          echo "cluster=wherewego-prod-cluster" >> $GITHUB_OUTPUT
          echo "service=wherewego-prod-service" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-Deploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Notify deployment start
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"attachments\": [{
              \"color\": \"#ff9500\",
              \"blocks\": [{
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"ğŸš€ *ë°°í¬ ì‹œì‘!* âš¡\\nìƒˆ ë²„ì „ì„ ì„œë²„ì— ë°°í¬ ì¤‘...\"
                }
              }]
            }]
          }" ${{ secrets.SLACK_WEBHOOK }}

      - name: Update task definition and start deployment
        run: |
          DEPLOY_START=$(date +%s)
          
          # ECR URIë¥¼ íƒœìŠ¤í¬ ì •ì˜ì— ë°˜ì˜
          sed "s|ECR_URI_PLACEHOLDER|${{ needs.build.outputs.image-uri }}|g" aws/task-definition.json > temp-task-definition.json
          
          # íƒœìŠ¤í¬ ì •ì˜ ë“±ë¡
          TASK_DEF_ARN=$(aws ecs register-task-definition --cli-input-json file://temp-task-definition.json --query 'taskDefinition.taskDefinitionArn' --output text)
          echo "âœ… Task definition registered: $TASK_DEF_ARN"
          
          # ì„œë¹„ìŠ¤ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          SERVICE_EXISTS=$(aws ecs describe-services --cluster ${{ steps.set-deploy-vars.outputs.cluster }} --services ${{ steps.set-deploy-vars.outputs.service }} --query 'length(services)' --output text 2>/dev/null || echo "0")
          
          if [[ "$SERVICE_EXISTS" == "0" ]]; then
            echo "ğŸš€ Creating new ECS service..."
          
            # CloudFormation Outputsì—ì„œ ë¦¬ì†ŒìŠ¤ ID ê°€ì ¸ì˜¤ê¸°
            PUBLIC_SUBNET_1=$(aws cloudformation describe-stacks \
              --stack-name "wherewego-${{ needs.build.outputs.environment }}" \
              --query 'Stacks[0].Outputs[?OutputKey==`PublicSubnet1`].OutputValue' \
              --output text)
              
            PUBLIC_SUBNET_2=$(aws cloudformation describe-stacks \
              --stack-name "wherewego-${{ needs.build.outputs.environment }}" \
              --query 'Stacks[0].Outputs[?OutputKey==`PublicSubnet2`].OutputValue' \
              --output text)
              
            ECS_SECURITY_GROUP=$(aws cloudformation describe-stacks \
              --stack-name "wherewego-${{ needs.build.outputs.environment }}" \
              --query 'Stacks[0].Outputs[?OutputKey==`ECSSecurityGroup`].OutputValue' \
              --output text)
            
            echo "ğŸ“‹ CloudFormation Stack: wherewego-${{ needs.build.outputs.environment }}"
            echo "ğŸ”— Using subnets: $PUBLIC_SUBNET_1, $PUBLIC_SUBNET_2"
            echo "ğŸ›¡ï¸ Using security group: $ECS_SECURITY_GROUP"
          
            # ECS ì„œë¹„ìŠ¤ ìƒì„±
            aws ecs create-service \
              --cluster ${{ steps.set-deploy-vars.outputs.cluster }} \
              --service-name ${{ steps.set-deploy-vars.outputs.service }} \
              --task-definition ${{ env.CONTAINER_NAME }} \
              --desired-count 1 \
              --launch-type FARGATE \
              --network-configuration "awsvpcConfiguration={subnets=[$PUBLIC_SUBNET_1,$PUBLIC_SUBNET_2],securityGroups=[$ECS_SECURITY_GROUP],assignPublicIp=ENABLED}"
          else
            echo "ğŸ”„ Updating existing ECS service..."
          
            # ê¸°ì¡´ ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸
            aws ecs update-service \
              --cluster ${{ steps.set-deploy-vars.outputs.cluster }} \
              --service ${{ steps.set-deploy-vars.outputs.service }} \
              --task-definition ${{ env.CONTAINER_NAME }} \
              --desired-count 1
          fi
          
          DEPLOY_END=$(date +%s)
          DEPLOY_DURATION=$((DEPLOY_END - DEPLOY_START))
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          rm temp-task-definition.json
          
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"attachments\": [{
              \"color\": \"#36a64f\",
              \"blocks\": [{
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"âš¡ *ë°°í¬ ì‹œì‘ë¨!* ğŸ¯\\nì„œë¹„ìŠ¤ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.\"
                }
              }, {
                \"type\": \"section\",
                \"fields\": [{
                  \"type\": \"mrkdwn\",
                  \"text\": \"*ë°°í¬ ì‹œê°„:*\\nâ±ï¸ ${DEPLOY_DURATION}ì´ˆ\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*ìƒíƒœ:*\\nğŸ”„ í—¬ìŠ¤ì²´í¬ ì§„í–‰ ì¤‘\"
                }]
              }]
            }]
          }" ${{ secrets.SLACK_WEBHOOK }}

  verify:
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-Verify
          aws-region: ${{ env.AWS_REGION }}

      - name: Wait for service stability and final notification
        run: |
          VERIFY_START=$(date +%s)
          
          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\": \"ğŸ¥ í—¬ìŠ¤ì²´í¬ ì§„í–‰ ì¤‘... (ì•½ 3-5ë¶„ ì†Œìš”)\"}" ${{ secrets.SLACK_WEBHOOK }}
          
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            # ì„œë¹„ìŠ¤ ì•ˆì •í™” ëŒ€ê¸°
            echo "â³ Waiting for service stability..."
            aws ecs wait services-stable \
              --cluster ${{ needs.deploy.outputs.cluster }} \
              --services ${{ needs.deploy.outputs.service }} \
              --cli-read-timeout 600 || echo "âš ï¸ íƒ€ì„ì•„ì›ƒì´ì§€ë§Œ ì„œë¹„ìŠ¤ëŠ” ë°±ê·¸ë¼ìš´ë“œì—ì„œ ê³„ì† ì§„í–‰ë©ë‹ˆë‹¤"
          fi
          
          VERIFY_END=$(date +%s)
          VERIFY_DURATION=$((VERIFY_END - VERIFY_START))
          VERIFY_MIN=$((VERIFY_DURATION / 60))
          VERIFY_SEC=$((VERIFY_DURATION % 60))
          
          # ì „ì²´ ê²°ê³¼ì— ë”°ë¥¸ ë©”ì‹œì§€ ì„¤ì •
          if [[ "${{ needs.build.result }}" == "success" && "${{ needs.deploy.result }}" == "success" ]]; then
            COLOR="good"
            STATUS="âœ… SUCCESS"
            MESSAGE="ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
            EMOJI="ğŸ‰"
          else
            COLOR="danger" 
            STATUS="âŒ FAILED"
            if [[ "${{ needs.build.result }}" == "failure" ]]; then
              MESSAGE="ë¹Œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
            elif [[ "${{ needs.deploy.result }}" == "failure" ]]; then
              MESSAGE="ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
            else
              MESSAGE="ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
            fi
            EMOJI="ğŸ’¥"
          fi
          
          # ë¸Œëœì¹˜ì— ë”°ë¥¸ í™˜ê²½ ì´ëª¨ì§€
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENV_ICON="ğŸš€"
            ENV_NAME="Production"
          else
            ENV_ICON="ğŸ§ª"
            ENV_NAME="Development"
          fi
          
          # ì»¤ë°‹ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          COMMIT_MSG=$(echo "$COMMIT_MSG" | head -c 50)
          
          # ìµœì¢… Slack ë©”ì‹œì§€ ì „ì†¡
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"attachments\": [{
              \"color\": \"$COLOR\",
              \"blocks\": [{
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"$EMOJI $ENV_ICON *WhereWeGo Deployment* $STATUS\\n$MESSAGE\"
                }
              }, {
                \"type\": \"section\",
                \"fields\": [{
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Environment:*\\n$ENV_NAME\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Branch:*\\n\`${{ github.ref_name }}\`\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*í—¬ìŠ¤ì²´í¬:*\\nâ±ï¸ ${VERIFY_MIN}ë¶„ ${VERIFY_SEC}ì´ˆ\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Author:*\\nğŸ‘¤ ${{ github.actor }}\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Commit:*\\n<https://github.com/${{ github.repository }}/commit/${{ github.sha }}|\`$(echo ${{ github.sha }} | cut -c1-8)\`>\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Message:*\\nğŸ’¬ $COMMIT_MSG\"
                }]
              }, {
                \"type\": \"actions\",
                \"elements\": [{
                  \"type\": \"button\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"ğŸ” View Workflow\"
                  },
                  \"url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
                }]
              }]
            }]
          }" ${{ secrets.SLACK_WEBHOOK }}