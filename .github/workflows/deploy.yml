name: Deploy to AWS ECS

on:
  push:
    branches: [ main, dev, feature/docker-deployment ]

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: wherewego-app
  CONTAINER_NAME: wherewego-app

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/feature/docker-deployment'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Notify deployment start
        run: |
          # ë°°í¬ ì‹œì‘ ì•Œë¦¼
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENV_ICON="ğŸš€"
            ENV_NAME="Production"
          else
            ENV_ICON="ğŸ§ª"
            ENV_NAME="Development"
          fi
          
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"attachments\": [{
              \"color\": \"#36a64f\",
              \"blocks\": [{
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"$ENV_ICON *WhereWeGo Deployment Started* ğŸ\në°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...\"
                }
              }, {
                \"type\": \"section\",
                \"fields\": [{
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Environment:*\n$ENV_NAME (${{ env.ENVIRONMENT }})\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Branch:*\n\`${{ github.ref_name }}\`\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Commit:*\n<https://github.com/${{ github.repository }}/commit/${{ github.sha }}|\`$(echo ${{ github.sha }} | cut -c1-8)\`>\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Author:*\n${{ github.actor }}\"
                }]
              }]
            }]
          }" ${{ secrets.SLACK_WEBHOOK }}

      - name: Set environment variables
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "ENVIRONMENT=prod" >> $GITHUB_ENV
            echo "ECS_CLUSTER=wherewego-prod-cluster" >> $GITHUB_ENV
            echo "ECS_SERVICE=wherewego-prod-service" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=prod" >> $GITHUB_ENV
            echo "ECS_CLUSTER=wherewego-prod-cluster" >> $GITHUB_ENV
            echo "ECS_SERVICE=wherewego-prod-service" >> $GITHUB_ENV
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Notify build start
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \"âš™ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘... (ì•½ 2-3ë¶„ ì†Œìš”)\"
          }" ${{ secrets.SLACK_WEBHOOK }}

      - name: Build and push Docker image
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # ë¹Œë“œ ì‹œì‘ ì‹œê°„ ê¸°ë¡
          BUILD_START=$(date +%s)
          # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          
          # latest íƒœê·¸ë„ í‘¸ì‹œ
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT
          
          # ë¹Œë“œ ì™„ë£Œ ì•Œë¦¼
          BUILD_END=$(date +%s)
          BUILD_DURATION=$((BUILD_END - BUILD_START))
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \"âœ… Docker ë¹Œë“œ ì™„ë£Œ! ECR ì—…ë¡œë“œ ì¤‘... (ì†Œìš”ì‹œê°„: ${BUILD_DURATION}ì´ˆ)\"
          }" ${{ secrets.SLACK_WEBHOOK }}

      - name: Notify ECS deployment start
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \"ğŸ”„ ECS ì„œë¹„ìŠ¤ ë°°í¬ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!\"
          }" ${{ secrets.SLACK_WEBHOOK }}

      - name: Update task definition and deploy
        run: |
          # ë°°í¬ ì‹œì‘ ì‹œê°„ ê¸°ë¡
          DEPLOY_START=$(date +%s)
          # ECR URIë¥¼ íƒœìŠ¤í¬ ì •ì˜ì— ë°˜ì˜
          sed "s|ECR_URI_PLACEHOLDER|${{ steps.login-ecr.outputs.registry }}/$ECR_REPOSITORY:${{ github.sha }}|g" aws/task-definition.json > temp-task-definition.json
          
          # íƒœìŠ¤í¬ ì •ì˜ ë“±ë¡
          TASK_DEF_ARN=$(aws ecs register-task-definition --cli-input-json file://temp-task-definition.json --query 'taskDefinition.taskDefinitionArn' --output text)
          echo "âœ… Task definition registered: $TASK_DEF_ARN"
          
          # ì„œë¹„ìŠ¤ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          SERVICE_EXISTS=$(aws ecs describe-services --cluster ${{ env.ECS_CLUSTER }} --services ${{ env.ECS_SERVICE }} --query 'length(services)' --output text 2>/dev/null || echo "0")
          
          if [[ "$SERVICE_EXISTS" == "0" ]]; then
            echo "ğŸš€ Creating new ECS service..."
          
            # CloudFormation Outputsì—ì„œ ë¦¬ì†ŒìŠ¤ ID ê°€ì ¸ì˜¤ê¸° (ìœ ë™ì )
            PUBLIC_SUBNET_1=$(aws cloudformation describe-stacks \
              --stack-name "wherewego-${{ env.ENVIRONMENT }}" \
              --query 'Stacks[0].Outputs[?OutputKey==`PublicSubnet1`].OutputValue' \
              --output text)
              
            PUBLIC_SUBNET_2=$(aws cloudformation describe-stacks \
              --stack-name "wherewego-${{ env.ENVIRONMENT }}" \
              --query 'Stacks[0].Outputs[?OutputKey==`PublicSubnet2`].OutputValue' \
              --output text)
              
            ECS_SECURITY_GROUP=$(aws cloudformation describe-stacks \
              --stack-name "wherewego-${{ env.ENVIRONMENT }}" \
              --query 'Stacks[0].Outputs[?OutputKey==`ECSSecurityGroup`].OutputValue' \
              --output text)
            
            echo "ğŸ“‹ CloudFormation Stack: wherewego-${{ env.ENVIRONMENT }}"
            echo "ğŸ”— Using subnets: $PUBLIC_SUBNET_1, $PUBLIC_SUBNET_2"
            echo "ğŸ›¡ï¸ Using security group: $ECS_SECURITY_GROUP"
          
            # ECS ì„œë¹„ìŠ¤ ìƒì„±
            aws ecs create-service \
              --cluster ${{ env.ECS_CLUSTER }} \
              --service-name ${{ env.ECS_SERVICE }} \
              --task-definition ${{ env.CONTAINER_NAME }} \
              --desired-count 1 \
              --launch-type FARGATE \
              --network-configuration "awsvpcConfiguration={subnets=[$PUBLIC_SUBNET_1,$PUBLIC_SUBNET_2],securityGroups=[$ECS_SECURITY_GROUP],assignPublicIp=ENABLED}"
          else
            echo "ğŸ”„ Updating existing ECS service..."
          
            # ê¸°ì¡´ ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸
            aws ecs update-service \
              --cluster ${{ env.ECS_CLUSTER }} \
              --service ${{ env.ECS_SERVICE }} \
              --task-definition ${{ env.CONTAINER_NAME }} \
              --desired-count 1
          
            # ì„œë¹„ìŠ¤ ì•ˆì •í™” ëŒ€ê¸°
            echo "â³ Waiting for service stability..."
            aws ecs wait services-stable \
              --cluster ${{ env.ECS_CLUSTER }} \
              --services ${{ env.ECS_SERVICE }}
          fi
          
          echo "âœ… Deployment completed successfully!"
          
          # ë°°í¬ ì™„ë£Œ ì‹œê°„ ê³„ì‚°
          DEPLOY_END=$(date +%s)
          DEPLOY_DURATION=$((DEPLOY_END - DEPLOY_START))
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          rm temp-task-definition.json
          
          # ë°°í¬ ë‹¨ê³„ ì™„ë£Œ ì•Œë¦¼
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \"ğŸ¯ ECS ë°°í¬ ì™„ë£Œ! (ì†Œìš”ì‹œê°„: ${DEPLOY_DURATION}ì´ˆ) ìµœì¢… ê²€ì¦ ì¤‘...\"
          }" ${{ secrets.SLACK_WEBHOOK }}

      - name: Final deployment notification
        if: always()
        run: |
          # ì „ì²´ ì‹¤í–‰ ì‹œê°„ ê³„ì‚° (job ì‹œì‘ë¶€í„°)
          JOB_START_TIME=$(date -d "${{ github.event.head_commit.timestamp }}" +%s)
          JOB_END_TIME=$(date +%s)
          TOTAL_DURATION=$((JOB_END_TIME - JOB_START_TIME))
          DURATION_MIN=$((TOTAL_DURATION / 60))
          DURATION_SEC=$((TOTAL_DURATION % 60))
          
          # ë°°í¬ ê²°ê³¼ì— ë”°ë¥¸ ë©”ì‹œì§€ ì„¤ì •
          if [[ "${{ job.status }}" == "success" ]]; then
            COLOR="good"
            STATUS="âœ… SUCCESS"
            MESSAGE="ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
            EMOJI="ğŸ‰"
          else
            COLOR="danger" 
            STATUS="âŒ FAILED"
            MESSAGE="ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
            EMOJI="ğŸ’¥"
          fi
          
          # ë¸Œëœì¹˜ì— ë”°ë¥¸ í™˜ê²½ ì´ëª¨ì§€
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENV_ICON="ğŸš€"
            ENV_NAME="Production"
          else
            ENV_ICON="ğŸ§ª"
            ENV_NAME="Development"
          fi
          
          # ì»¤ë°‹ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
          COMMIT_MSG=$(git log -1 --pretty=format:"%s" | head -c 50)
          
          # Slack ë©”ì‹œì§€ ì „ì†¡
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"attachments\": [{
              \"color\": \"$COLOR\",
              \"blocks\": [{
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"$EMOJI $ENV_ICON *WhereWeGo Deployment* $STATUS\n$MESSAGE\"
                }
              }, {
                \"type\": \"section\",
                \"fields\": [{
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Environment:*\n$ENV_NAME (${{ env.ENVIRONMENT }})\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Branch:*\n\`${{ github.ref_name }}\`\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Duration:*\nâ±ï¸ ${DURATION_MIN}ë¶„ ${DURATION_SEC}ì´ˆ\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Author:*\nğŸ‘¤ ${{ github.actor }}\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Commit:*\n<https://github.com/${{ github.repository }}/commit/${{ github.sha }}|\`$(echo ${{ github.sha }} | cut -c1-8)\`>\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Message:*\nğŸ’¬ $COMMIT_MSG\"
                }]
              }, {
                \"type\": \"actions\",
                \"elements\": [{
                  \"type\": \"button\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"ğŸ” View Workflow\"
                  },
                  \"url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
                }, {
                  \"type\": \"button\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"ğŸš€ View App\"
                  },
                  \"url\": \"https://wherewego-app.example.com\"
                }]
              }]
            }]
          }" ${{ secrets.SLACK_WEBHOOK }}