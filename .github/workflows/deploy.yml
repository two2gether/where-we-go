name: Deploy to AWS ECS

on:
  push:
    branches: [ main, dev, feature/docker-deployment, feat/frontend-clean ]

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: wherewego-app
  CONTAINER_NAME: wherewego-app

permissions:
  id-token: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/feature/docker-deployment' || github.ref == 'refs/heads/feat/frontend-clean'
    outputs:
      image-uri: ${{ steps.build-image.outputs.image }}
      environment: ${{ steps.set-env.outputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Notify build start
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENV_ICON="üöÄ"
            ENV_NAME="Production"
          else
            ENV_ICON="üß™"
            ENV_NAME="Development"
          fi
          
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"attachments\": [{
              \"color\": \"#36a64f\",
              \"blocks\": [{
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"$ENV_ICON *WhereWeGo Build Started* üî®\\nÎπåÎìúÎ•º ÏãúÏûëÌï©ÎãàÎã§...\"
                }
              }, {
                \"type\": \"section\",
                \"fields\": [{
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Environment:*\\n$ENV_NAME\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Branch:*\\n\`${{ github.ref_name }}\`\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Commit:*\\n<https://github.com/${{ github.repository }}/commit/${{ github.sha }}|\`$(echo ${{ github.sha }} | cut -c1-8)\`>\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Author:*\\n${{ github.actor }}\"
                }]
              }]
            }]
          }" ${{ secrets.SLACK_WEBHOOK }}

      - name: Set environment variables
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          else
            echo "environment=prod" >> $GITHUB_OUTPUT
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Frontend
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\": \"üé® ÌîÑÎ°†Ìä∏ÏóîÎìú ÎπåÎìú Ï§ë... (ÏïΩ 1-2Î∂Ñ ÏÜåÏöî)\"}" ${{ secrets.SLACK_WEBHOOK }}
          
          cd frontend
          npm ci
          npm run build
          cd ..

      - name: Build with Gradle
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\": \"‚öôÔ∏è Gradle ÎπåÎìú Ï§ë... (ÏïΩ 1-2Î∂Ñ ÏÜåÏöî)\"}" ${{ secrets.SLACK_WEBHOOK }}
          
          ./gradlew clean build -x test

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-Build
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          BUILD_START=$(date +%s)
          
          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\": \"üê≥ Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú Ï§ë... (ÏïΩ 2-3Î∂Ñ ÏÜåÏöî)\"}" ${{ secrets.SLACK_WEBHOOK }}
          
          # Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú Î∞è Ìë∏Ïãú
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          
          # latest ÌÉúÍ∑∏ÎèÑ Ìë∏Ïãú
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT
          
          BUILD_END=$(date +%s)
          BUILD_DURATION=$((BUILD_END - BUILD_START))
          
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"attachments\": [{
              \"color\": \"good\",
              \"blocks\": [{
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"üéâ *ÎπåÎìú ÏôÑÎ£å!* ‚úÖ\\nÎ∞∞Ìè¨ Ï§ÄÎπÑÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.\"
                }
              }, {
                \"type\": \"section\",
                \"fields\": [{
                  \"type\": \"mrkdwn\",
                  \"text\": \"*ÎπåÎìú ÏãúÍ∞Ñ:*\\n‚è±Ô∏è ${BUILD_DURATION}Ï¥à\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Îã§Ïùå Îã®Í≥Ñ:*\\nüöÄ Î∞∞Ìè¨ ÏãúÏûë ÏòàÏ†ï\"
                }]
              }]
            }]
          }" ${{ secrets.SLACK_WEBHOOK }}

  deploy:
    runs-on: ubuntu-latest
    needs: build
    outputs:
      cluster: ${{ steps.set-deploy-vars.outputs.cluster }}
      service: ${{ steps.set-deploy-vars.outputs.service }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js for deployment
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Set deployment variables
        id: set-deploy-vars
        run: |
          echo "cluster=wherewego-prod-cluster" >> $GITHUB_OUTPUT
          echo "service=wherewego-prod-service" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-Deploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Notify deployment start
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"attachments\": [{
              \"color\": \"#ff9500\",
              \"blocks\": [{
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"üöÄ *Î∞∞Ìè¨ ÏãúÏûë!* ‚ö°\\nÏÉà Î≤ÑÏ†ÑÏùÑ ÏÑúÎ≤ÑÏóê Î∞∞Ìè¨ Ï§ë...\"
                }
              }]
            }]
          }" ${{ secrets.SLACK_WEBHOOK }}


      - name: Update task definition and start deployment
        run: |
          DEPLOY_START=$(date +%s)
          
          # ECR URIÎ•º ÌÉúÏä§ÌÅ¨ Ï†ïÏùòÏóê Î∞òÏòÅ
          sed "s|ECR_URI_PLACEHOLDER|${{ needs.build.outputs.image-uri }}|g" aws/task-definition.json > temp-task-definition.json
          
          # ÌÉúÏä§ÌÅ¨ Ï†ïÏùò Îì±Î°ù
          TASK_DEF_ARN=$(aws ecs register-task-definition --cli-input-json file://temp-task-definition.json --query 'taskDefinition.taskDefinitionArn' --output text)
          echo "‚úÖ Task definition registered: $TASK_DEF_ARN"
          
          # ÏÑúÎπÑÏä§ Ï°¥Ïû¨ Ïó¨Î∂Ä ÌôïÏù∏
          SERVICE_EXISTS=$(aws ecs describe-services --cluster ${{ steps.set-deploy-vars.outputs.cluster }} --services ${{ steps.set-deploy-vars.outputs.service }} --query 'length(services)' --output text 2>/dev/null || echo "0")
          
          if [[ "$SERVICE_EXISTS" == "0" ]]; then
            echo "üöÄ Creating new ECS service..."
          
            # CloudFormation OutputsÏóêÏÑú Î¶¨ÏÜåÏä§ ID Í∞ÄÏ†∏Ïò§Í∏∞
            PUBLIC_SUBNET_1=$(aws cloudformation describe-stacks \
              --stack-name "wherewego-${{ needs.build.outputs.environment }}" \
              --query 'Stacks[0].Outputs[?OutputKey==`PublicSubnet1`].OutputValue' \
              --output text)
              
            PUBLIC_SUBNET_2=$(aws cloudformation describe-stacks \
              --stack-name "wherewego-${{ needs.build.outputs.environment }}" \
              --query 'Stacks[0].Outputs[?OutputKey==`PublicSubnet2`].OutputValue' \
              --output text)
              
            ECS_SECURITY_GROUP=$(aws cloudformation describe-stacks \
              --stack-name "wherewego-${{ needs.build.outputs.environment }}" \
              --query 'Stacks[0].Outputs[?OutputKey==`ECSSecurityGroup`].OutputValue' \
              --output text)
              
            ALB_TARGET_GROUP_ARN=$(aws cloudformation describe-stacks \
              --stack-name "wherewego-${{ needs.build.outputs.environment }}" \
              --query 'Stacks[0].Outputs[?OutputKey==`ALBTargetGroupArn`].OutputValue' \
              --output text)
            
            echo "üìã CloudFormation Stack: wherewego-${{ needs.build.outputs.environment }}"
            echo "üîó Using subnets: $PUBLIC_SUBNET_1, $PUBLIC_SUBNET_2"
            echo "üõ°Ô∏è Using security group: $ECS_SECURITY_GROUP"
            echo "üéØ Using target group: $ALB_TARGET_GROUP_ARN"
          
            # ECS ÏÑúÎπÑÏä§ ÏÉùÏÑ±
            aws ecs create-service \
              --cluster ${{ steps.set-deploy-vars.outputs.cluster }} \
              --service-name ${{ steps.set-deploy-vars.outputs.service }} \
              --task-definition ${{ env.CONTAINER_NAME }} \
              --desired-count 1 \
              --launch-type FARGATE \
              --network-configuration "awsvpcConfiguration={subnets=[$PUBLIC_SUBNET_1,$PUBLIC_SUBNET_2],securityGroups=[$ECS_SECURITY_GROUP],assignPublicIp=ENABLED}" \
              --load-balancers "targetGroupArn=$ALB_TARGET_GROUP_ARN,containerName=${{ env.CONTAINER_NAME }},containerPort=8080"
          else
            echo "üîÑ Updating existing ECS service..."
          
            # Í∏∞Ï°¥ ÏÑúÎπÑÏä§ ÏóÖÎç∞Ïù¥Ìä∏
            aws ecs update-service \
              --cluster ${{ steps.set-deploy-vars.outputs.cluster }} \
              --service ${{ steps.set-deploy-vars.outputs.service }} \
              --task-definition ${{ env.CONTAINER_NAME }} \
              --desired-count 1
          fi
          
          DEPLOY_END=$(date +%s)
          DEPLOY_DURATION=$((DEPLOY_END - DEPLOY_START))
          
          # ÏûÑÏãú ÌååÏùº Ï†ïÎ¶¨
          rm temp-task-definition.json
          
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"attachments\": [{
              \"color\": \"#36a64f\",
              \"blocks\": [{
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"‚ö° *Î∞∞Ìè¨ ÏãúÏûëÎê®!* üéØ\\nÏÑúÎπÑÏä§Í∞Ä ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.\"
                }
              }, {
                \"type\": \"section\",
                \"fields\": [{
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Î∞∞Ìè¨ ÏãúÍ∞Ñ:*\\n‚è±Ô∏è ${DEPLOY_DURATION}Ï¥à\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*ÏÉÅÌÉú:*\\nüîÑ Ìó¨Ïä§Ï≤¥ÌÅ¨ ÏßÑÌñâ Ï§ë\"
                }]
              }]
            }]
          }" ${{ secrets.SLACK_WEBHOOK }}
          
          # Ï†ëÏÜç URL Ï°∞Ìöå
          FRONTEND_URL=$(aws cloudformation describe-stacks \
            --stack-name "wherewego-${{ needs.build.outputs.environment }}" \
            --query 'Stacks[0].Outputs[?OutputKey==`FrontendURL`].OutputValue' \
            --output text 2>/dev/null || echo "http://wherewego-prod-frontend.s3-website.ap-northeast-2.amazonaws.com")
          
          # Î∞±ÏóîÎìú Public IP Ï°∞Ìöå
          BACKEND_PUBLIC_IP=$(aws ecs list-tasks \
            --cluster ${{ steps.set-deploy-vars.outputs.cluster }} \
            --service-name ${{ steps.set-deploy-vars.outputs.service }} \
            --query 'taskArns[0]' --output text 2>/dev/null | \
            xargs -I {} aws ecs describe-tasks \
            --cluster ${{ steps.set-deploy-vars.outputs.cluster }} \
            --tasks {} \
            --query 'tasks[0].attachments[0].details[?name==`networkInterfaceId`].value' \
            --output text 2>/dev/null | \
            xargs -I {} aws ec2 describe-network-interfaces \
            --network-interface-ids {} \
            --query 'NetworkInterfaces[0].Association.PublicIp' \
            --output text 2>/dev/null || echo "Ï°∞ÌöåÏ§ë")
            
          if [[ "$BACKEND_PUBLIC_IP" != "Ï°∞ÌöåÏ§ë" && "$BACKEND_PUBLIC_IP" != "None" && "$BACKEND_PUBLIC_IP" != "" ]]; then
            BACKEND_HEALTH_URL="http://${BACKEND_PUBLIC_IP}:8080/actuator/health"
          else
            BACKEND_HEALTH_URL="Î∞±ÏóîÎìú IP Ï°∞Ìöå Ï§ë..."
          fi
          
          # Î∞∞Ìè¨ ÏßÑÌñâ ÏÉÅÌÉú ÏïåÎ¶º (URL Ï†úÏô∏)
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"attachments\": [{
              \"color\": \"#36a64f\",
              \"blocks\": [{
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"‚ö° *Î∞∞Ìè¨ ÏãúÏûëÎê®!* üéØ\\nÏÑúÎπÑÏä§Í∞Ä ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.\"
                }
              }, {
                \"type\": \"section\",
                \"fields\": [{
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Î∞∞Ìè¨ ÏãúÍ∞Ñ:*\\n‚è±Ô∏è ${DEPLOY_DURATION}Ï¥à\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*ÏÉÅÌÉú:*\\nüîÑ Ìó¨Ïä§Ï≤¥ÌÅ¨ ÏßÑÌñâ Ï§ë\"
                }]
              }]
            }]
          }" ${{ secrets.SLACK_WEBHOOK }}

  frontend:
    runs-on: ubuntu-latest
    needs: [build, deploy, verify]
    if: always() && needs.verify.result == 'success'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js for frontend deployment
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-Frontend
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Frontend to S3
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\": \"üé® ÌîÑÎ°†Ìä∏ÏóîÎìú Î∞∞Ìè¨ ÏãúÏûë... (Î∞±ÏóîÎìú Î∞∞Ìè¨ ÏôÑÎ£å ÌõÑ)\"}" ${{ secrets.SLACK_WEBHOOK }}

          # Get S3 bucket names from Parameter Store
          S3_BUCKET=$(aws ssm get-parameter --name "/wherewego/aws/s3/frontend-bucket" --query 'Parameter.Value' --output text)
          IMAGE_S3_BUCKET=$(aws ssm get-parameter --name "/wherewego/aws/s3/images-bucket" --query 'Parameter.Value' --output text)
          AWS_DEFAULT_REGION=$(aws ssm get-parameter --name "/wherewego/aws/region" --query 'Parameter.Value' --output text)
          
          echo "üì¶ Frontend S3 Bucket: $S3_BUCKET"
          echo "üñºÔ∏è Image S3 Bucket: $IMAGE_S3_BUCKET"
          
          # Get ECS Task Public IP (after backend verification completed)
          echo "üîç ÏïàÏ†ïÌôîÎêú ECS ÏÑúÎπÑÏä§ÏóêÏÑú Public IP Ï°∞Ìöå Ï§ë..."
          ECS_PUBLIC_IP=$(aws ecs list-tasks \
            --cluster ${{ needs.deploy.outputs.cluster }} \
            --service-name ${{ needs.deploy.outputs.service }} \
            --query 'taskArns[0]' --output text | \
            xargs -I {} aws ecs describe-tasks \
            --cluster ${{ needs.deploy.outputs.cluster }} \
            --tasks {} \
            --query 'tasks[0].attachments[0].details[?name==`networkInterfaceId`].value' \
            --output text | \
            xargs -I {} aws ec2 describe-network-interfaces \
            --network-interface-ids {} \
            --query 'NetworkInterfaces[0].Association.PublicIp' \
            --output text)
          
          echo "üåê ÏµúÏ¢Ö ECS Public IP: $ECS_PUBLIC_IP"
          
          # Build frontend with production environment variables
          cd frontend
          npm ci
          
          # Get environment variables from Parameter Store
          KAKAO_CLIENT_ID=$(aws ssm get-parameter --name "/wherewego/kakao/client-id" --query 'Parameter.Value' --output text)
          GOOGLE_MAPS_API_KEY=$(aws ssm get-parameter --name "/wherewego/google/maps-api-key" --with-decryption --query 'Parameter.Value' --output text)
          GOOGLE_CLIENT_ID=$(aws ssm get-parameter --name "/wherewego/google/client-id" --query 'Parameter.Value' --output text)
          
          # Hardcoded OAuth redirect URIs for production
          GOOGLE_REDIRECT_URI="http://wherewego-prod-frontend.s3-website.ap-northeast-2.amazonaws.com/auth/google/callback"
          KAKAO_REDIRECT_URI="http://wherewego-prod-frontend.s3-website.ap-northeast-2.amazonaws.com/auth/kakao/callback"
          
          # Get additional parameters for environment variables
          S3_BUCKET=$(aws ssm get-parameter --name "/wherewego/aws/s3/frontend-bucket" --query 'Parameter.Value' --output text)
          AWS_DEFAULT_REGION=$(aws ssm get-parameter --name "/wherewego/aws/region" --query 'Parameter.Value' --output text)
          
          echo "üîß Frontend URL: http://${S3_BUCKET}.s3-website.${AWS_DEFAULT_REGION}.amazonaws.com"
          
          # Create production environment file with verified backend IP
          cat > .env.production << EOF
          VITE_API_BASE_URL=http://${ECS_PUBLIC_IP}:8080/api
          VITE_IMAGE_BUCKET_URL=https://${IMAGE_S3_BUCKET}.s3.${AWS_DEFAULT_REGION}.amazonaws.com
          VITE_KAKAO_APP_KEY=${KAKAO_CLIENT_ID}
          VITE_GOOGLE_MAPS_API_KEY=${GOOGLE_MAPS_API_KEY}
          VITE_GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
          VITE_DEV_MODE=false
          VITE_LOG_LEVEL=warn
          EOF
          
          echo "üîß ÏÉùÏÑ±Îêú ÌôòÍ≤ΩÎ≥ÄÏàò:"
          cat .env.production
          
          npm run build
          
          # Upload to S3 with proper website configuration
          aws s3 sync dist/ s3://$S3_BUCKET --delete
          
          # Enable S3 static website hosting
          aws s3 website s3://$S3_BUCKET --index-document index.html --error-document index.html
          
          cd ..
          
          # Final success notification with URLs
          FRONTEND_URL="http://${S3_BUCKET}.s3-website.${AWS_DEFAULT_REGION}.amazonaws.com"
          BACKEND_HEALTH_URL="http://${ECS_PUBLIC_IP}:8080/actuator/health"
          
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"attachments\": [{
              \"color\": \"good\",
              \"blocks\": [{
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"üéâ *Ï†ÑÏ≤¥ Î∞∞Ìè¨ ÏôÑÎ£å!* ‚úÖ\\nÌîÑÎ°†Ìä∏ÏóîÎìúÏôÄ Î∞±ÏóîÎìúÍ∞Ä Î™®Îëê Ïó∞Í≤∞ÎêòÏóàÏäµÎãàÎã§.\"
                }
              }, {
                \"type\": \"section\",
                \"fields\": [{
                  \"type\": \"mrkdwn\",
                  \"text\": \"*üåê ÌîÑÎ°†Ìä∏ÏóîÎìú:*\\n<$FRONTEND_URL|ÏõπÏÇ¨Ïù¥Ìä∏ Ïó¥Í∏∞>\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*‚öôÔ∏è Î∞±ÏóîÎìú Ìó¨Ïä§Ï≤¥ÌÅ¨:*\\n<$BACKEND_HEALTH_URL|API ÏÉÅÌÉú ÌôïÏù∏>\"
                }]
              }]
            }]
          }" ${{ secrets.SLACK_WEBHOOK }}

  verify:
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-Verify
          aws-region: ${{ env.AWS_REGION }}

      - name: Wait for service stability and final notification
        run: |
          VERIFY_START=$(date +%s)
          
          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\": \"üè• Ìó¨Ïä§Ï≤¥ÌÅ¨ ÏßÑÌñâ Ï§ë... (ÏïΩ 3-5Î∂Ñ ÏÜåÏöî)\"}" ${{ secrets.SLACK_WEBHOOK }}
          
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            # ÏÑúÎπÑÏä§ ÏïàÏ†ïÌôî ÎåÄÍ∏∞
            echo "‚è≥ Waiting for service stability..."
            aws ecs wait services-stable \
              --cluster ${{ needs.deploy.outputs.cluster }} \
              --services ${{ needs.deploy.outputs.service }} \
              --cli-read-timeout 600 || echo "‚ö†Ô∏è ÌÉÄÏûÑÏïÑÏõÉÏù¥ÏßÄÎßå ÏÑúÎπÑÏä§Îäî Î∞±Í∑∏ÎùºÏö¥ÎìúÏóêÏÑú Í≥ÑÏÜç ÏßÑÌñâÎê©ÎãàÎã§"
          fi
          
          VERIFY_END=$(date +%s)
          VERIFY_DURATION=$((VERIFY_END - VERIFY_START))
          VERIFY_MIN=$((VERIFY_DURATION / 60))
          VERIFY_SEC=$((VERIFY_DURATION % 60))
          
          # Ï†ÑÏ≤¥ Í≤∞Í≥ºÏóê Îî∞Î•∏ Î©îÏãúÏßÄ ÏÑ§Ï†ï
          if [[ "${{ needs.build.result }}" == "success" && "${{ needs.deploy.result }}" == "success" ]]; then
            COLOR="good"
            STATUS="‚úÖ SUCCESS"
            MESSAGE="Î∞∞Ìè¨Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!"
            EMOJI="üéâ"
          else
            COLOR="danger" 
            STATUS="‚ùå FAILED"
            if [[ "${{ needs.build.result }}" == "failure" ]]; then
              MESSAGE="ÎπåÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
            elif [[ "${{ needs.deploy.result }}" == "failure" ]]; then
              MESSAGE="Î∞∞Ìè¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
            else
              MESSAGE="Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
            fi
            EMOJI="üí•"
          fi
          
          # Î∏åÎûúÏπòÏóê Îî∞Î•∏ ÌôòÍ≤Ω Ïù¥Î™®ÏßÄ
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENV_ICON="üöÄ"
            ENV_NAME="Production"
          else
            ENV_ICON="üß™"
            ENV_NAME="Development"
          fi
          
          # Ïª§Î∞ã Î©îÏãúÏßÄ Í∞ÄÏ†∏Ïò§Í∏∞
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          COMMIT_MSG=$(echo "$COMMIT_MSG" | head -c 50)
          
          # ÌîÑÎ°†Ìä∏ÏóîÎìú URL Í∞ÄÏ†∏Ïò§Í∏∞
          FRONTEND_URL=$(aws cloudformation describe-stacks \
            --stack-name "wherewego-${{ needs.build.outputs.environment }}" \
            --query 'Stacks[0].Outputs[?OutputKey==`FrontendURL`].OutputValue' \
            --output text 2>/dev/null || echo "http://wherewego-prod-frontend.s3-website.ap-northeast-2.amazonaws.com")
            
          # Î∞±ÏóîÎìú URL Í∞ÄÏ†∏Ïò§Í∏∞ (ECS Public IP)  
          echo "üîç ÏµúÏ¢Ö ECS Public IP ÌôïÏù∏ Ï§ë..."
          BACKEND_PUBLIC_IP=$(aws ecs list-tasks \
            --cluster ${{ needs.deploy.outputs.cluster }} \
            --service-name ${{ needs.deploy.outputs.service }} \
            --query 'taskArns[0]' --output text 2>/dev/null | \
            xargs -I {} aws ecs describe-tasks \
            --cluster ${{ needs.deploy.outputs.cluster }} \
            --tasks {} \
            --query 'tasks[0].attachments[0].details[?name==`networkInterfaceId`].value' \
            --output text 2>/dev/null | \
            xargs -I {} aws ec2 describe-network-interfaces \
            --network-interface-ids {} \
            --query 'NetworkInterfaces[0].Association.PublicIp' \
            --output text 2>/dev/null || echo "IP Ï°∞Ìöå Ïã§Ìå®")
          
          if [[ "$BACKEND_PUBLIC_IP" != "IP Ï°∞Ìöå Ïã§Ìå®" && "$BACKEND_PUBLIC_IP" != "None" && "$BACKEND_PUBLIC_IP" != "" ]]; then
            BACKEND_URL="http://${BACKEND_PUBLIC_IP}:8080/actuator/health"
            echo "‚úÖ Backend Public IP: $BACKEND_PUBLIC_IP"
            echo "üîó Backend Health Check: $BACKEND_URL"
          else
            BACKEND_URL="Backend IP Ï°∞Ìöå Ï§ë... (ÏÑúÎπÑÏä§ ÏãúÏûë ÎåÄÍ∏∞)"
            echo "‚ö†Ô∏è Backend Public IP Ï°∞Ìöå Ïã§Ìå® ÎòêÎäî ÏïÑÏßÅ Ìï†ÎãπÎêòÏßÄ ÏïäÏùå"
          fi
          
          # URL Ï†ïÎ≥¥ GitHub Actions ÏöîÏïΩÏóê Ï∂úÎ†•
          echo "## üöÄ Î∞∞Ìè¨ ÏôÑÎ£å!" >> $GITHUB_STEP_SUMMARY
          echo "### üì± Ï†ëÏÜç Ï†ïÎ≥¥" >> $GITHUB_STEP_SUMMARY
          echo "- **ÌîÑÎ°†Ìä∏ÏóîÎìú**: $FRONTEND_URL" >> $GITHUB_STEP_SUMMARY  
          echo "- **Î∞±ÏóîÎìú**: $BACKEND_URL" >> $GITHUB_STEP_SUMMARY
          echo "- **ÌôòÍ≤Ω**: $ENV_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- **Î∏åÎûúÏπò**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          
          # ÏµúÏ¢Ö Slack Î©îÏãúÏßÄ Ï†ÑÏÜ°
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"attachments\": [{
              \"color\": \"$COLOR\",
              \"blocks\": [{
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"$EMOJI $ENV_ICON *WhereWeGo Deployment* $STATUS\\n$MESSAGE\"
                }
              }, {
                \"type\": \"section\",
                \"fields\": [{
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Environment:*\\n$ENV_NAME\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Branch:*\\n\`${{ github.ref_name }}\`\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Ìó¨Ïä§Ï≤¥ÌÅ¨:*\\n‚è±Ô∏è ${VERIFY_MIN}Î∂Ñ ${VERIFY_SEC}Ï¥à\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Author:*\\nüë§ ${{ github.actor }}\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Commit:*\\n<https://github.com/${{ github.repository }}/commit/${{ github.sha }}|\`$(echo ${{ github.sha }} | cut -c1-8)\`>\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Message:*\\nüí¨ $COMMIT_MSG\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Frontend:*\\nüåê $FRONTEND_URL\"
                }, {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*Backend Health Check:*\\n‚öôÔ∏è $BACKEND_URL\"
                }]
              }, {
                \"type\": \"actions\",
                \"elements\": [{
                  \"type\": \"button\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"üîç View Workflow\"
                  },
                  \"url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
                }]
              }]
            }]
          }" ${{ secrets.SLACK_WEBHOOK }}